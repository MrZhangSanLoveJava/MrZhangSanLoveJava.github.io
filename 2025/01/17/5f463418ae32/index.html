<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="referrer" content="no-referrer">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha256-dABdfBfUoC8vJUBOwGVdm8L9qlMWaHTIfXt+7GnZCIo=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"www.puill.xin","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.22.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":true,"show_result":true,"style":"default"},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="在Linux上编程，直接进一个档次">
<meta property="og:type" content="article">
<meta property="og:title" content="Linux网络编程">
<meta property="og:url" content="http://www.puill.xin/2025/01/17/5f463418ae32/index.html">
<meta property="og:site_name" content="puill&#39;s Blog">
<meta property="og:description" content="在Linux上编程，直接进一个档次">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://gitee.com/Mr_zhang_yu_ge/puillimage/raw/master/%E6%9F%A5%E7%9C%8Bmac.png">
<meta property="og:image" content="https://gitee.com/Mr_zhang_yu_ge/puillimage/raw/master/%E6%9F%A5%E7%9C%8B%E5%AD%90%E7%BD%91id.png">
<meta property="og:image" content="https://gitee.com/Mr_zhang_yu_ge/puillimage/raw/master/7%E5%B1%82%E7%BB%93%E6%9E%84.png">
<meta property="og:image" content="https://gitee.com/Mr_zhang_yu_ge/puillimage/raw/master/4%E5%B1%82%E7%BB%93%E6%9E%84.png">
<meta property="og:image" content="https://gitee.com/Mr_zhang_yu_ge/puillimage/raw/master/mac%E5%A4%B4%E9%83%A8.png">
<meta property="og:image" content="https://gitee.com/Mr_zhang_yu_ge/puillimage/raw/master/mac%E5%A4%B4%E9%83%A82.png">
<meta property="og:image" content="https://gitee.com/Mr_zhang_yu_ge/puillimage/raw/master/%E7%BB%84%E5%8C%85%E8%BF%87%E7%A8%8B.png">
<meta property="og:image" content="https://gitee.com/Mr_zhang_yu_ge/puillimage/raw/master/arp%E8%AF%B7%E6%B1%82.png">
<meta property="og:image" content="https://gitee.com/Mr_zhang_yu_ge/puillimage/raw/master/arp%E5%A4%B4%E9%83%A8.png">
<meta property="og:image" content="https://gitee.com/Mr_zhang_yu_ge/puillimage/raw/master/arp%E9%80%9A%E8%AE%AF.png">
<meta property="og:image" content="https://gitee.com/Mr_zhang_yu_ge/puillimage/raw/master/%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B%E7%A4%BA%E6%84%8F%E5%9B%BE.png">
<meta property="og:image" content="https://gitee.com/Mr_zhang_yu_ge/puillimage/raw/master/%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B.png">
<meta property="og:image" content="https://gitee.com/Mr_zhang_yu_ge/puillimage/raw/master/%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B%E6%9C%8D%E5%8A%A1%E5%99%A8.png">
<meta property="og:image" content="https://gitee.com/Mr_zhang_yu_ge/puillimage/raw/master/TCP%E8%BD%AC%E6%8D%A2%E5%9B%BE.png">
<meta property="og:image" content="https://gitee.com/Mr_zhang_yu_ge/puillimage/raw/master/socket%E6%A8%A1%E5%9E%8B%E5%88%9B%E5%BB%BA%E6%B5%81%E7%A8%8B%E5%9B%BE.png">
<meta property="og:image" content="https://gitee.com/Mr_zhang_yu_ge/puillimage/raw/master/tcp%E6%9C%8D%E5%8A%A1%E9%80%9A%E4%BF%A1%E6%B5%81%E7%A8%8B1.png">
<meta property="og:image" content="https://gitee.com/Mr_zhang_yu_ge/puillimage/raw/master/tcp%E6%9C%8D%E5%8A%A1%E9%80%9A%E4%BF%A1%E6%B5%81%E7%A8%8B.png">
<meta property="og:image" content="https://gitee.com/Mr_zhang_yu_ge/puillimage/raw/master/%E5%A4%9A%E8%BF%9B%E7%A8%8B%E6%9C%8D%E5%8A%A1%E7%AB%AF.png">
<meta property="og:image" content="https://gitee.com/Mr_zhang_yu_ge/puillimage/raw/master/TFTP%E9%80%9A%E8%AE%AF%E8%BF%87%E7%A8%8B.png">
<meta property="og:image" content="https://gitee.com/Mr_zhang_yu_ge/puillimage/raw/master/TFTP%E5%8D%8F%E8%AE%AE%E5%88%86%E6%9E%90.png">
<meta property="og:image" content="https://gitee.com/Mr_zhang_yu_ge/puillimage/raw/master/TFTP%E5%B7%AE%E9%94%99%E7%A0%81.png">
<meta property="article:published_time" content="2025-01-17T13:43:31.000Z">
<meta property="article:modified_time" content="2025-01-17T13:48:39.910Z">
<meta property="article:author" content="puill">
<meta property="article:tag" content="Linux">
<meta property="article:tag" content="网络编程">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://gitee.com/Mr_zhang_yu_ge/puillimage/raw/master/%E6%9F%A5%E7%9C%8Bmac.png">


<link rel="canonical" href="http://www.puill.xin/2025/01/17/5f463418ae32/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"http://www.puill.xin/2025/01/17/5f463418ae32/","path":"2025/01/17/5f463418ae32/","title":"Linux网络编程"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Linux网络编程 | puill's Blog</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">puill's Blog</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-文章"><a href="/articles/" rel="section"><i class="fa fa-file-text fa-fw"></i>文章</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-友链"><a href="/friendchains/" rel="section"><i class="fa fa-paperclip fa-fw"></i>友链</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
      <div class="search-header">
        <span class="search-icon">
          <i class="fa fa-search"></i>
        </span>
        <div class="search-input-container">
          <input autocomplete="off" autocapitalize="off" maxlength="80"
                placeholder="搜索..." spellcheck="false"
                type="search" class="search-input">
        </div>
        <span class="popup-btn-close" role="button">
          <i class="fa fa-times-circle"></i>
        </span>
      </div>
      <div class="search-result-container">
        <div class="search-result-icon">
          <i class="fa fa-spinner fa-pulse fa-5x"></i>
        </div>
      </div>
    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Linux%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B"><span class="nav-number">1.</span> <span class="nav-text">Linux网络编程</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%80%E3%80%81%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B%E6%A6%82%E5%BF%B5"><span class="nav-number">1.1.</span> <span class="nav-text">一、网络编程概念</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-mac%E5%9C%B0%E5%9D%80"><span class="nav-number">1.1.1.</span> <span class="nav-text">1.mac地址</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-IP%E5%9C%B0%E5%9D%80"><span class="nav-number">1.1.2.</span> <span class="nav-text">2. IP地址</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E7%AB%AF%E5%8F%A3"><span class="nav-number">1.1.3.</span> <span class="nav-text">3.端口</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-OSI%E4%B8%83%E5%B1%82%E6%A8%A1%E5%9E%8B"><span class="nav-number">1.1.4.</span> <span class="nav-text">4.OSI七层模型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-%E5%8D%8F%E8%AE%AE"><span class="nav-number">1.1.5.</span> <span class="nav-text">5.协议</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-%E7%BD%91%E7%BB%9C%E9%80%9A%E8%AE%AF%E8%BF%87%E7%A8%8B"><span class="nav-number">1.1.6.</span> <span class="nav-text">6.网络通讯过程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-arp"><span class="nav-number">1.1.7.</span> <span class="nav-text">7.arp</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-%E7%BD%91%E7%BB%9C%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F"><span class="nav-number">1.1.8.</span> <span class="nav-text">8.网络设计模式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E8%AE%AF"><span class="nav-number">1.1.9.</span> <span class="nav-text">9.进程间通讯</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#10-%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B"><span class="nav-number">1.1.10.</span> <span class="nav-text">10.三次握手</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#11-%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B"><span class="nav-number">1.1.11.</span> <span class="nav-text">11.四次挥手</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#12-mss"><span class="nav-number">1.1.12.</span> <span class="nav-text">12.mss</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#13-MTU"><span class="nav-number">1.1.13.</span> <span class="nav-text">13.MTU</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#14-2MSL"><span class="nav-number">1.1.14.</span> <span class="nav-text">14.2MSL</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#14-%E6%BB%91%E5%8A%A8%E7%AA%97%E5%8F%A3"><span class="nav-number">1.1.15.</span> <span class="nav-text">14.滑动窗口</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#15-TCP%E8%BD%AC%E6%8D%A2%E5%9B%BE"><span class="nav-number">1.1.16.</span> <span class="nav-text">15.TCP转换图</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%8C%E3%80%81Socket%E7%BC%96%E7%A8%8B"><span class="nav-number">1.2.</span> <span class="nav-text">二、Socket编程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E5%A5%97%E6%8E%A5%E5%AD%97%E6%A6%82%E5%BF%B5"><span class="nav-number">1.2.1.</span> <span class="nav-text">1.套接字概念</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E9%A2%84%E5%A4%87%E7%9F%A5%E8%AF%86"><span class="nav-number">1.2.2.</span> <span class="nav-text">2.预备知识</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-1-%E7%BD%91%E7%BB%9C%E5%AD%97%E8%8A%82%E5%BA%8F"><span class="nav-number">1.2.2.1.</span> <span class="nav-text">2.1 网络字节序</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-2-IP%E5%9C%B0%E5%9D%80%E8%BD%AC%E6%8D%A2%E5%87%BD%E6%95%B0"><span class="nav-number">1.2.2.2.</span> <span class="nav-text">2.2 IP地址转换函数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-3-sockaddr%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="nav-number">1.2.2.3.</span> <span class="nav-text">2.3 sockaddr数据结构</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E7%BD%91%E7%BB%9C%E5%A5%97%E6%8E%A5%E5%AD%97%E5%87%BD%E6%95%B0"><span class="nav-number">1.2.3.</span> <span class="nav-text">3.网络套接字函数</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3-1-socket%E6%A8%A1%E5%9E%8B%E5%88%9B%E5%BB%BA%E6%B5%81%E7%A8%8B%E5%9B%BE"><span class="nav-number">1.2.3.1.</span> <span class="nav-text">3.1 socket模型创建流程图</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-2-socket%E5%87%BD%E6%95%B0"><span class="nav-number">1.2.3.2.</span> <span class="nav-text">3.2 socket函数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-3-connect%E5%87%BD%E6%95%B0"><span class="nav-number">1.2.3.3.</span> <span class="nav-text">3.3 connect函数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-4-tcp%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%80%9A%E4%BF%A1%E6%B5%81%E7%A8%8B"><span class="nav-number">1.2.3.4.</span> <span class="nav-text">3.4 tcp服务器通信流程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-5-bind%E7%BB%91%E5%AE%9A"><span class="nav-number">1.2.3.5.</span> <span class="nav-text">3.5 bind绑定</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-6-listen"><span class="nav-number">1.2.3.6.</span> <span class="nav-text">3.6 listen</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-7-accept"><span class="nav-number">1.2.3.7.</span> <span class="nav-text">3.7 accept</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-8-tcp%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%80%9A%E4%BF%A1%E6%AD%A5%E9%AA%A4"><span class="nav-number">1.2.3.8.</span> <span class="nav-text">3.8 tcp服务器通信步骤</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-9-tcp%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%A4%9A%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%BF%9E%E6%8E%A5%EF%BC%88%E8%BF%9B%E7%A8%8B%E7%89%88%EF%BC%89"><span class="nav-number">1.2.3.9.</span> <span class="nav-text">3.9 tcp服务器多客户端连接（进程版）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-10-tcp%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%A4%9A%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%BF%9E%E6%8E%A5%EF%BC%88%E7%BA%BF%E7%A8%8B%E7%89%88%EF%BC%89"><span class="nav-number">1.2.3.10.</span> <span class="nav-text">3.10 tcp服务器多客户端连接（线程版）</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-%E5%8D%8A%E5%85%B3%E9%97%AD"><span class="nav-number">1.2.4.</span> <span class="nav-text">4.半关闭</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-%E5%BF%83%E8%B7%B3%E5%8C%85"><span class="nav-number">1.2.5.</span> <span class="nav-text">5.心跳包</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-%E8%AE%BE%E7%BD%AE%E7%AB%AF%E5%8F%A3%E5%A4%8D%E7%94%A8"><span class="nav-number">1.2.6.</span> <span class="nav-text">6.设置端口复用</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%89%E3%80%81%E9%AB%98%E5%B9%B6%E5%8F%91%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="nav-number">1.3.</span> <span class="nav-text">三、高并发服务器</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-select"><span class="nav-number">1.3.1.</span> <span class="nav-text">1.select</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-1-%E4%BD%BF%E7%94%A8select%E5%86%99TCP%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="nav-number">1.3.1.1.</span> <span class="nav-text">1.1 使用select写TCP服务器</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-2-select%E7%9A%84%E4%BC%98%E7%BC%BA%E7%82%B9"><span class="nav-number">1.3.1.2.</span> <span class="nav-text">1.2 select的优缺点</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-3-%E8%A7%A3%E5%86%B3%E7%BC%BA%E7%82%B9%E4%B8%AD%E7%9A%84%E9%97%AE%E9%A2%98"><span class="nav-number">1.3.1.3.</span> <span class="nav-text">1.3 解决缺点中的问题</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-poll"><span class="nav-number">1.3.2.</span> <span class="nav-text">2.poll</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-epoll"><span class="nav-number">1.3.3.</span> <span class="nav-text">3.epoll</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3-1-%E5%88%9B%E5%BB%BA%E7%BA%A2%E9%BB%91%E6%A0%91"><span class="nav-number">1.3.3.1.</span> <span class="nav-text">3.1 创建红黑树</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-2-%E4%B8%8A%E6%A0%91%E3%80%81%E4%B8%8B%E6%A0%91%E3%80%81%E4%BF%AE%E6%94%B9%E8%8A%82%E7%82%B9"><span class="nav-number">1.3.3.2.</span> <span class="nav-text">3.2 上树、下树、修改节点</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-3-%E7%9B%91%E5%90%AC"><span class="nav-number">1.3.3.3.</span> <span class="nav-text">3.3 监听</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9B%9B%E3%80%81TFTP"><span class="nav-number">1.4.</span> <span class="nav-text">四、TFTP</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-TFTP%E6%A6%82%E8%BF%B0"><span class="nav-number">1.4.1.</span> <span class="nav-text">1.TFTP概述</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-TFTP%E9%80%9A%E8%AE%AF%E8%BF%87%E7%A8%8B"><span class="nav-number">1.4.2.</span> <span class="nav-text">2.TFTP通讯过程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-TFTP%E5%8D%8F%E8%AE%AE%E5%88%86%E6%9E%90"><span class="nav-number">1.4.3.</span> <span class="nav-text">3.TFTP协议分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-TFTP%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="nav-number">1.4.4.</span> <span class="nav-text">4.TFTP客户端</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%94%E3%80%81UDP%E5%B9%BF%E6%92%AD"><span class="nav-number">1.5.</span> <span class="nav-text">五、UDP广播</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E5%B9%BF%E6%92%AD%E7%9A%84%E6%A6%82%E5%BF%B5"><span class="nav-number">1.5.1.</span> <span class="nav-text">1.广播的概念</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E5%B9%BF%E6%92%AD%E7%9A%84%E7%94%A8%E9%80%94"><span class="nav-number">1.5.2.</span> <span class="nav-text">2.广播的用途</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E5%B9%BF%E6%92%AD%E7%9A%84%E7%89%B9%E7%82%B9"><span class="nav-number">1.5.3.</span> <span class="nav-text">3.广播的特点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-%E5%B9%BF%E6%92%AD%E5%9C%B0%E5%9D%80"><span class="nav-number">1.5.4.</span> <span class="nav-text">4.广播地址</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%9C%AA%E5%AE%8C%E5%BE%85%E7%BB%AD%E2%80%A6%E4%B8%80%E7%9B%B4%E9%B8%BD%E7%9D%80%E7%9A%84"><span class="nav-number">2.</span> <span class="nav-text">未完待续…一直鸽着的</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="puill"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">puill</p>
  <div class="site-description" itemprop="description">puill的博客</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">25</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">5</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="mailto:2256044190@qq.com" title="E-Mail → mailto:2256044190@qq.com" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>
  <div class="cc-license animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://www.puill.xin/2025/01/17/5f463418ae32/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="puill">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="puill's Blog">
      <meta itemprop="description" content="puill的博客">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Linux网络编程 | puill's Blog">
      <meta itemprop="description" content="在Linux上编程，直接进一个档次">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Linux网络编程
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2025-01-17 21:43:31 / 修改时间：21:48:39" itemprop="dateCreated datePublished" datetime="2025-01-17T21:43:31+08:00">2025-01-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B/" itemprop="url" rel="index"><span itemprop="name">系统编程</span></a>
        </span>
    </span>

  
</div>

            <div class="post-description">在Linux上编程，直接进一个档次</div>
        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h1 id="Linux网络编程"><a href="#Linux网络编程" class="headerlink" title="Linux网络编程"></a>Linux网络编程</h1><h2 id="一、网络编程概念"><a href="#一、网络编程概念" class="headerlink" title="一、网络编程概念"></a>一、网络编程概念</h2><h3 id="1-mac地址"><a href="#1-mac地址" class="headerlink" title="1.mac地址"></a>1.mac地址</h3><p>标识网卡的id，理论上这个id全球唯一</p>
<p>mac地址一般用来标识主机的id，这个id是物理地址，不会改变</p>
<p><img src="https://gitee.com/Mr_zhang_yu_ge/puillimage/raw/master/%E6%9F%A5%E7%9C%8Bmac.png"></p>
<h3 id="2-IP地址"><a href="#2-IP地址" class="headerlink" title="2. IP地址"></a>2. IP地址</h3><p>IP地址是标识主机的id，这个id是虚拟的，会改变的。</p>
<p>一个IP将其分为子网id和主机id，子网id和主机id需要和子网掩码一起看，比如说下面有一个IP地址和子网掩码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">10.1.1.2</span><br><span class="line">255.255.255.0</span><br></pre></td></tr></table></figure>

<p>上面的192.168.11.23是IP地址，而下面的255.255.255.0是子网掩码，查看时需要看下面的子网掩码。</p>
<p>IP中被连续的1覆盖的位就是子网id</p>
<p>IP中被连续的0覆盖的位就是主机id</p>
<p><img src="https://gitee.com/Mr_zhang_yu_ge/puillimage/raw/master/%E6%9F%A5%E7%9C%8B%E5%AD%90%E7%BD%91id.png"></p>
<p>所以子网id是：10.1.1</p>
<p>主机id是：2</p>
<p>网段地址：10.1.1.0</p>
<p>广播地址：10.1.1.255</p>
<p>主机id分配的范围：10.1.1.1-&gt;10.1.1.254</p>
<p>ping：这是一个用来测试两台主机的网络联通性的命令</p>
<p>ens33是网络名称</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">192.168.131.133 设置的ip</span><br><span class="line">netmask子网掩码255.255.255.0</span><br></pre></td></tr></table></figure>

<h3 id="3-端口"><a href="#3-端口" class="headerlink" title="3.端口"></a>3.端口</h3><p>作用：用来标识应用程序（进程）</p>
<p>port：2个字节 0-65535</p>
<p>0-1023知名端口</p>
<p>自定义端口1024-65535</p>
<h3 id="4-OSI七层模型"><a href="#4-OSI七层模型" class="headerlink" title="4.OSI七层模型"></a>4.OSI七层模型</h3><p>物理层：双绞线接口类型，光纤的传输速率等等</p>
<p>数据链路层：mac 负责收发数据</p>
<p>网络层：IP 给两台提供路径选择</p>
<p>传输层：port 区分数据递送到哪一个应用程序</p>
<p>会话层：建立连接</p>
<p>表示层：解码</p>
<p>应用层：应用程序，拿到数据</p>
<p><img src="https://gitee.com/Mr_zhang_yu_ge/puillimage/raw/master/7%E5%B1%82%E7%BB%93%E6%9E%84.png"></p>
<p>TCP&#x2F;IP四层协议</p>
<p><img src="https://gitee.com/Mr_zhang_yu_ge/puillimage/raw/master/4%E5%B1%82%E7%BB%93%E6%9E%84.png"></p>
<h3 id="5-协议"><a href="#5-协议" class="headerlink" title="5.协议"></a>5.协议</h3><p>规定了数据传输的方法和格式</p>
<p>应用层协议：<br>FTP：文本传输协议</p>
<p>HTTP：超文本传输协议</p>
<p>NFS：网络文件系统</p>
<p>传输层协议：</p>
<p>TCP：传输控制协议</p>
<p>UDP：用户数据包协议</p>
<p>网络层协议：</p>
<p>IP：因特网互联协议</p>
<p>ICMP：因特网控制报文协议，比如ping</p>
<p>IGMP：因特网组管理协议</p>
<p>链路层协议：<br>ARP：地址解析协议 通过IP找mac地址</p>
<p>RARP：反向地址解析协议，通过mac找IP</p>
<p>mac头部：</p>
<p><img src="https://gitee.com/Mr_zhang_yu_ge/puillimage/raw/master/mac%E5%A4%B4%E9%83%A8.png"></p>
<p><img src="https://gitee.com/Mr_zhang_yu_ge/puillimage/raw/master/mac%E5%A4%B4%E9%83%A82.png"></p>
<h3 id="6-网络通讯过程"><a href="#6-网络通讯过程" class="headerlink" title="6.网络通讯过程"></a>6.网络通讯过程</h3><p><img src="https://gitee.com/Mr_zhang_yu_ge/puillimage/raw/master/%E7%BB%84%E5%8C%85%E8%BF%87%E7%A8%8B.png"></p>
<h3 id="7-arp"><a href="#7-arp" class="headerlink" title="7.arp"></a>7.arp</h3><p>地址解析协议：通过IP找mac地址</p>
<p><img src="https://gitee.com/Mr_zhang_yu_ge/puillimage/raw/master/arp%E8%AF%B7%E6%B1%82.png"></p>
<p>arp请求包：</p>
<p><img src="https://gitee.com/Mr_zhang_yu_ge/puillimage/raw/master/arp%E5%A4%B4%E9%83%A8.png"></p>
<p><img src="https://gitee.com/Mr_zhang_yu_ge/puillimage/raw/master/arp%E9%80%9A%E8%AE%AF.png"></p>
<h3 id="8-网络设计模式"><a href="#8-网络设计模式" class="headerlink" title="8.网络设计模式"></a>8.网络设计模式</h3><p>有两种设计模式</p>
<p>B&#x2F;S browser&#x2F;server 使用服务器进行计算</p>
<p>优点：客户端安全，开发周期短</p>
<p>缺点：性能低</p>
<p>C&#x2F;S cilent&#x2F;server 使用客户端就行计算</p>
<p>优点：性能好</p>
<p>缺点：客户端容易篡改数据，开发周期较长</p>
<h3 id="9-进程间通讯"><a href="#9-进程间通讯" class="headerlink" title="9.进程间通讯"></a>9.进程间通讯</h3><p>之前学习了一些进程间的通讯，比如无名管道、有名管道、mmap、文件、信号、消息队列、共享内存，但这些通讯都存在一个问题就是只能用于本机的进程间通讯。</p>
<p>如果我们想让不同的主机之间进行通讯，我们需要使用到 socket。</p>
<h3 id="10-三次握手"><a href="#10-三次握手" class="headerlink" title="10.三次握手"></a>10.三次握手</h3><p>在TCP通讯的时候会需要进行三次握手，当上次握手结束后就会建立TCP的通讯。一般使用在连接。</p>
<p>这个过程和我们打电话的过程是一样的，当你打了一个电话给对方首先需要确定一下对方是不是接通了，就得先说一声喂，对方收到你的喂后也会回复一个喂，接收到这个喂之后再进行一个确认就可以与对方进行通话了。</p>
<p>三次握手的示意图如下：</p>
<p><img src="https://gitee.com/Mr_zhang_yu_ge/puillimage/raw/master/%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B%E7%A4%BA%E6%84%8F%E5%9B%BE.png"></p>
<p>当客户端连接服务器的时候会先发送一个数据包，数据包中的<code>SYN</code>位会置为1，当服务器接收到这个数据包后也会发送一个数据包给客户端，告诉客户端我已经接收到你的连接，而这个数据包中的<code>ACK</code>会置为1，当客户端接收到这个服务器的数据包后又会再发送一个数据包，这个数据包中的<code>SYN</code>会置为0，发送完这个数据包后就可以开始通讯了。</p>
<p>而每个数据包中都有一个序列号<code>seq</code>和确定序列号<code>ack</code>，序列号是拿来表示发送的数据包的序号的，而确定序列号的含义有两条：</p>
<ul>
<li>确定收到对方的数据包</li>
<li>期待下一次对方的序列号为我的确定序列号</li>
</ul>
<p>这里的握手必须得是三次，因为在传输的过程中很有可能会发生传输了一个数据包但是延迟比较高的情况，如果是只握两次手，那么第一次扔包过去的时候可能时间会很长，那么客户端又会扔一个数据包，这个数据包一下子就扔到了服务器上，然后服务器马上就返回一个确定数据包，然后客户端就开始通讯了，在通讯的时候，第一次扔的包成功的给到了服务器，服务器又以为要建立一个行的连接，这个时候就会产生另外一个连接队列，但本质上两个队列都是一样的。</p>
<p>而如果是三次握手，客户端已经确定好连接了，当那个包又回来时，服务器就会自动忽略那个数据包，就不会再创建一个连接队列了。</p>
<h3 id="11-四次挥手"><a href="#11-四次挥手" class="headerlink" title="11.四次挥手"></a>11.四次挥手</h3><p>四次挥手一般出现在关闭连接的时候。</p>
<p>这个过程可以理解为你和别人打电话结束后要挂电话的情况，你要挂电话你就得说我要挂了，对方会回复说好的，然后就会说我也要挂掉电话了，然后你回复好的，就可以把电话挂了。</p>
<p>四次挥手的示意图如下：</p>
<p><img src="https://gitee.com/Mr_zhang_yu_ge/puillimage/raw/master/%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B.png"></p>
<p>主动方执行<code>close</code>时，就会给被动方一个数据包，这个数据包中<code>FIN</code>置为1，然后被动方接收到这个关闭数据包后也会回复一个数据包，这个数据包中<code>ACK</code>为1，<code>FIN</code>为0，紧接着再发送一个挂掉的数据包，也就是<code>close</code>，这个数据包和主动方第一次发送的包一样，然后等待主动方发送挂掉的数据包，接收到这个数据包后就可以结束连接了。</p>
<p>而这个主动和被动可以是客户端主动，服务器被动，也可以是服务器主动，客户端被动，这个无所谓的</p>
<p><img src="https://gitee.com/Mr_zhang_yu_ge/puillimage/raw/master/%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B%E6%9C%8D%E5%8A%A1%E5%99%A8.png"></p>
<p>而最大报文生存时间是被动方需要等待的，不管被动方是哪一个。</p>
<p>在这个过程中虽然调用了close，但是还是可以收发数据的，这个过程叫做半关闭，半关闭的函数后面会说</p>
<h3 id="12-mss"><a href="#12-mss" class="headerlink" title="12.mss"></a>12.mss</h3><p>mss是最大报文长度，一般出现在三次握手的前两次，用来告诉对方发送数据的最大长度。</p>
<h3 id="13-MTU"><a href="#13-MTU" class="headerlink" title="13.MTU"></a>13.MTU</h3><p>网卡的最大传输单元</p>
<h3 id="14-2MSL"><a href="#14-2MSL" class="headerlink" title="14.2MSL"></a>14.2MSL</h3><p>为了让4次握手关闭流程更加可靠。还有其它功能，但这里只了解这个问题即可。</p>
<h3 id="14-滑动窗口"><a href="#14-滑动窗口" class="headerlink" title="14.滑动窗口"></a>14.滑动窗口</h3><p>每一次读取数据之后，回ack报文，报文中携带当前缓冲区大小，用来告知对方我缓冲区的空间。</p>
<h3 id="15-TCP转换图"><a href="#15-TCP转换图" class="headerlink" title="15.TCP转换图"></a>15.TCP转换图</h3><p>TCP转换图其实如下</p>
<p><img src="https://gitee.com/Mr_zhang_yu_ge/puillimage/raw/master/TCP%E8%BD%AC%E6%8D%A2%E5%9B%BE.png"></p>
<p>本质上就是在建立连接和断开连接的过程中主动方和被动方的一些标志位</p>
<h2 id="二、Socket编程"><a href="#二、Socket编程" class="headerlink" title="二、Socket编程"></a>二、Socket编程</h2><h3 id="1-套接字概念"><a href="#1-套接字概念" class="headerlink" title="1.套接字概念"></a>1.套接字概念</h3><p>套接字其实就是一个插座，是计算机之间进行通讯的一种约定或一种方法。</p>
<h3 id="2-预备知识"><a href="#2-预备知识" class="headerlink" title="2.预备知识"></a>2.预备知识</h3><h4 id="2-1-网络字节序"><a href="#2-1-网络字节序" class="headerlink" title="2.1 网络字节序"></a>2.1 网络字节序</h4><p>这里需要重新回忆一下C语言中的大端存储和小端存储了。其实也就是每个人的计算机的字节序存储方式不一样，有些是大端存储，而有些是小端存储，如果直接进行通讯就像中国人和英语人交流信笺一样，两边的人都看不懂对象书写的内容，这个时候如果在写信的时候将自己写的内容转换成对方看得懂的内容是不是就能很好的解决看不懂的问题了。</p>
<p>为了使网络程序具有可移植性，使同样的C代码在大端计算机和小端计算机上编译后都能正常运行，就可以使用以下库函数做网络字节序和主机字节序的转换</p>
<p>主机字节序转换为网络字节序</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="type">uint32_t</span> <span class="title function_">htonl</span><span class="params">(<span class="type">uint32_t</span> hostlong)</span>;</span><br><span class="line">功能：</span><br><span class="line">    将无符号整数hostlong从主机字节序转换为网络字节序</span><br><span class="line">参数：</span><br><span class="line">    hostlong：需要转换的主机字节序</span><br><span class="line">返回值：</span><br><span class="line">    转换后的网络字节序</span><br><span class="line"><span class="type">uint16_t</span> <span class="title function_">htons</span><span class="params">(<span class="type">uint16_t</span> hostshort)</span>;</span><br><span class="line">功能：</span><br><span class="line">    将无符号短整型hostshort从主机字节序转换为网络字节序</span><br><span class="line">参数：</span><br><span class="line">    hostshort：需要转换的主机字节序</span><br><span class="line">返回值：</span><br><span class="line">    转换后的网络字节序    </span><br></pre></td></tr></table></figure>

<p>网络字节序转换成主机字节序</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="type">uint32_t</span> <span class="title function_">ntohl</span><span class="params">(<span class="type">uint32_t</span> netlong)</span>;</span><br><span class="line">功能：</span><br><span class="line">    将无符号短整数netlong转换为主机字节序</span><br><span class="line">参数：</span><br><span class="line">    netlong：需要转换的网络字节序</span><br><span class="line">返回值：</span><br><span class="line">    转换后的主机字节序</span><br><span class="line"><span class="type">uint16_t</span> <span class="title function_">ntohs</span><span class="params">(<span class="type">uint16_t</span> netshort)</span>;</span><br><span class="line">功能：</span><br><span class="line">    将无符号短整数netshort转换为主机字节序</span><br><span class="line">参数：</span><br><span class="line">    netshort：需要转换的网络字节序</span><br><span class="line">返回值：</span><br><span class="line">    转换后的主机字节序</span><br></pre></td></tr></table></figure>

<p>示例程序：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="comment">//将长主机字节序转换为网络字节序</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> buf[] = &#123;<span class="number">192</span>, <span class="number">168</span>, <span class="number">1</span>, <span class="number">2</span>&#125;;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> num = *((<span class="type">unsigned</span> <span class="type">int</span>*)buf);</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> sum = htonl(num);</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span>* p = (<span class="type">unsigned</span> <span class="type">char</span>*)&amp;sum;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d.%d.%d.%d\n&quot;</span>, *p, *(p+<span class="number">1</span>), *(p+<span class="number">2</span>), *(p+<span class="number">3</span>));</span><br><span class="line">    <span class="comment">//将短主机字节序转换为网络字节序</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> a = <span class="number">0x0102</span>;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> b = htons(a);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%x\n&quot;</span>, b);</span><br><span class="line">    <span class="comment">//将长网络字节序转换为主机字节序</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> c = ntohl(sum);</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span>* pc = (<span class="type">unsigned</span> <span class="type">char</span>*)&amp;c;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d.%d.%d.%d\n&quot;</span>, *pc, *(pc+<span class="number">1</span>), *(pc+<span class="number">2</span>), *(pc+<span class="number">3</span>));</span><br><span class="line">    <span class="comment">//将短网络字节序转换为主机字节序</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> d = htons(b);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%x\n&quot;</span>, d);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-2-IP地址转换函数"><a href="#2-2-IP地址转换函数" class="headerlink" title="2.2 IP地址转换函数"></a>2.2 IP地址转换函数</h4><p>当你选择已经有一个需要发送的IP：192.168.1.2，你如果直接发送，网络是没办法知道你这个是什么内容的，需要进行一次转换将192.168.1.2转换为192，168，1，2这种使用数组存放的形式。而网络传给主机的IP地址为192，168，1，2这种使用数组的IP地址，所以需要经过转换变成192.168.1.2的形式。</p>
<p>在C语言中提供了两个函数来处理：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">inet_pton</span><span class="params">(<span class="type">int</span> af, <span class="type">const</span> <span class="type">char</span>* src, <span class="type">void</span>* dst)</span>;</span><br><span class="line">功能；</span><br><span class="line">    将点分十进制串转成<span class="number">32</span>位网络大端的数据</span><br><span class="line">参数：</span><br><span class="line">    af：</span><br><span class="line">        AF_INET	IPV4</span><br><span class="line">        AF_INET6 IPV6</span><br><span class="line">    src：点分十进制串的首地址</span><br><span class="line">    dst：<span class="number">32</span>位网络数据的地址</span><br><span class="line">返回值：</span><br><span class="line">    成功：返回<span class="number">1</span>（网络地址已成功连接）</span><br><span class="line">    失败：<span class="number">0</span>（src 不包含表示指定地址系列中有效网络地址的字符串）</span><br><span class="line">        <span class="number">-1</span>（af 不包含有效的地址系列）</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* <span class="title function_">inet_ntop</span><span class="params">(<span class="type">int</span> af, <span class="type">const</span> <span class="type">void</span>* src, <span class="type">char</span>* dst, <span class="type">socklen_t</span> size)</span>;</span><br><span class="line">功能：</span><br><span class="line">    将<span class="number">32</span>位大端的网络数据转成点分十进制</span><br><span class="line">参数：</span><br><span class="line">    af：</span><br><span class="line">        AF_INET	IPV4</span><br><span class="line">        AF_INET6 IPV6</span><br><span class="line">    src：<span class="number">32</span>位大端网络数地址</span><br><span class="line">    dst：存储点分十进制串地址</span><br><span class="line">    size：存储点分制串数组的大小</span><br><span class="line">返回值：</span><br><span class="line">    存储点分制串数组首地址</span><br></pre></td></tr></table></figure>

<p>示例程序：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> buf[] = <span class="string">&quot;192.168.1.2&quot;</span>;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> ip[<span class="number">16</span>];</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> number = <span class="number">0</span>;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span>* p = <span class="literal">NULL</span>;</span><br><span class="line">    inet_pton(AF_INET, buf, &amp;number);</span><br><span class="line">    p = (<span class="type">unsigned</span> <span class="type">char</span>*)&amp;number;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d %d %d %d\n&quot;</span>, *p, *(p+<span class="number">1</span>), *(p + <span class="number">2</span>), *(p + <span class="number">3</span>));</span><br><span class="line">    inet_ntop(AF_INET, &amp;number, ip, <span class="number">16</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, ip);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-3-sockaddr数据结构"><a href="#2-3-sockaddr数据结构" class="headerlink" title="2.3 sockaddr数据结构"></a>2.3 sockaddr数据结构</h4><p>ipv4套接字结构体</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> &#123;</span></span><br><span class="line">    <span class="type">sa_family_t</span> sin_family; <span class="comment">/* 地址族: AF_INET */</span></span><br><span class="line">    <span class="type">u_int16_t</span> sin_port; <span class="comment">/* 按网络字节次序的端口 */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">in_addr</span> <span class="title">sin_addr</span>;</span> <span class="comment">/* internet地址 */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Internet地址. */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">in_addr</span> &#123;</span></span><br><span class="line">    <span class="type">u_int32_t</span> s_addr; <span class="comment">/* 按网络字节次序的地址 */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>ipv6套接字结构体</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in6</span> &#123;</span></span><br><span class="line">    <span class="type">sa_family_t</span>     sin6_family;   <span class="comment">/* AF_INET6 */</span></span><br><span class="line">    <span class="type">in_port_t</span>       sin6_port;     <span class="comment">/* port number */</span></span><br><span class="line">    <span class="type">uint32_t</span>        sin6_flowinfo; <span class="comment">/* IPv6 flow information */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">in6_addr</span> <span class="title">sin6_addr</span>;</span>     <span class="comment">/* IPv6 address */</span></span><br><span class="line">    <span class="type">uint32_t</span>        sin6_scope_id; <span class="comment">/* Scope ID (new in 2.4) */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">in6_addr</span> &#123;</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span>   s6_addr[<span class="number">16</span>];   <span class="comment">/* IPv6 address */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>通用套接字结构体</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sockaddr</span>&#123;</span></span><br><span class="line">    <span class="type">sa_family_t</span> sa_family; <span class="comment">/*AF_xxx*/</span></span><br><span class="line">    <span class="type">char</span> sa_data[<span class="number">14</span>];	<span class="comment">/*通用的地址*/</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-网络套接字函数"><a href="#3-网络套接字函数" class="headerlink" title="3.网络套接字函数"></a>3.网络套接字函数</h3><h4 id="3-1-socket模型创建流程图"><a href="#3-1-socket模型创建流程图" class="headerlink" title="3.1 socket模型创建流程图"></a>3.1 socket模型创建流程图</h4><p><img src="https://gitee.com/Mr_zhang_yu_ge/puillimage/raw/master/socket%E6%A8%A1%E5%9E%8B%E5%88%9B%E5%BB%BA%E6%B5%81%E7%A8%8B%E5%9B%BE.png"></p>
<h4 id="3-2-socket函数"><a href="#3-2-socket函数" class="headerlink" title="3.2 socket函数"></a>3.2 socket函数</h4><p>创建套接字</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">socket</span><span class="params">(<span class="type">int</span> domain, <span class="type">int</span> type, <span class="type">int</span> protocol)</span>;</span><br><span class="line">功能：</span><br><span class="line">    建立一个用于交流的端点并且返回一个描述符</span><br><span class="line">参数：</span><br><span class="line">    domain：AF_INET</span><br><span class="line">    type：确定通信语句</span><br><span class="line">        SOCK_STREAM 提供有序的，可靠的，双向的，基于字节流的通讯。可能支持带外传输。</span><br><span class="line">        SOCK_DGRAM 提供数据报（不面向连接的, 不可靠的固定最大长度的信息）。</span><br><span class="line">        SOCK_SEQPACKET 提供有序的，可靠的，双向的，基于固定最大长度的数据报传输路径；需要一个读取整个伴有输入系统调用的包的用户。</span><br><span class="line">        SOCK_RAW 提供未加工(raw)的网络协议通道。</span><br><span class="line">        SOCK_RDM 提供可靠的数据报层，但是不保证顺序。</span><br><span class="line">        SOCK_NONBLOCK 设置  O_NONBLOCK 的标志于新打开的文件描述符。 通过这个标志可以不用调用 fcntl(<span class="number">2</span>) 来达到相同的结果。</span><br><span class="line">        SOCK_CLOEXEC 设置 close-on-exec  (FD_CLOEXEC)  的标志于新打开的文件描述符。参见 open(<span class="number">2</span>) 中关于 O_CLOEXEC 的描述，因为一些原因这个标志很有用。</span><br><span class="line">    protocol：指定一个协议用于套接字，一般为<span class="number">0</span></span><br><span class="line">返回值：</span><br><span class="line">    成功：文件描述符</span><br><span class="line">    失败：<span class="number">-1</span></span><br></pre></td></tr></table></figure>

<h4 id="3-3-connect函数"><a href="#3-3-connect函数" class="headerlink" title="3.3 connect函数"></a>3.3 connect函数</h4><p>连接服务器</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">connect</span><span class="params">(<span class="type">int</span> sockfd, <span class="type">const</span> <span class="keyword">struct</span> sockaddr* addr, <span class="type">socklen_t</span> addrlen)</span>;</span><br><span class="line">功能：</span><br><span class="line">    连接服务器的函数</span><br><span class="line">参数：</span><br><span class="line">    sockfd：套接字文件描述符</span><br><span class="line">    addr：ipv4或者ipv6的结构体，但需要转换为通用结构体</span><br><span class="line">    addrlen：结构体的大小。</span><br><span class="line">返回值：</span><br><span class="line">    成功：<span class="number">0</span></span><br><span class="line">    失败：<span class="number">-1</span></span><br></pre></td></tr></table></figure>

<p>示例程序：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">int</span> sock_fd, n;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">sa</span>;</span></span><br><span class="line">    <span class="comment">//创建套接字</span></span><br><span class="line">    sock_fd = socket(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">    <span class="comment">//连接主机</span></span><br><span class="line">    sa.sin_family = AF_INET;</span><br><span class="line">    sa.sin_port = htons(<span class="number">8080</span>);</span><br><span class="line">    inet_pton(AF_INET, <span class="string">&quot;192.168.160.1&quot;</span>, &amp;sa.sin_addr.s_addr);</span><br><span class="line">    connect(sock_fd, (<span class="keyword">struct</span> sockaddr*)&amp;sa, <span class="keyword">sizeof</span>(sa));</span><br><span class="line">    <span class="comment">//发送内容</span></span><br><span class="line">    <span class="type">char</span> buf[<span class="number">1024</span>];</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">        read(STDIN_FILENO, buf, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">        write(sock_fd, buf, <span class="keyword">sizeof</span>(buf));<span class="comment">//发送数据给服务器</span></span><br><span class="line">        n = read(sock_fd, buf, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">        write(STDIN_FILENO, buf, n);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//关闭文件描述符</span></span><br><span class="line">    close(sock_fd);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-4-tcp服务器通信流程"><a href="#3-4-tcp服务器通信流程" class="headerlink" title="3.4 tcp服务器通信流程"></a>3.4 tcp服务器通信流程</h4><p><img src="https://gitee.com/Mr_zhang_yu_ge/puillimage/raw/master/tcp%E6%9C%8D%E5%8A%A1%E9%80%9A%E4%BF%A1%E6%B5%81%E7%A8%8B1.png"></p>
<p><img src="https://gitee.com/Mr_zhang_yu_ge/puillimage/raw/master/tcp%E6%9C%8D%E5%8A%A1%E9%80%9A%E4%BF%A1%E6%B5%81%E7%A8%8B.png"></p>
<h4 id="3-5-bind绑定"><a href="#3-5-bind绑定" class="headerlink" title="3.5 bind绑定"></a>3.5 bind绑定</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">bind</span><span class="params">(<span class="type">int</span> sockfd, <span class="type">const</span> <span class="keyword">struct</span> sockaddr* addr, <span class="type">socklen_t</span> addrlen)</span>;</span><br><span class="line">功能：</span><br><span class="line">    给套接字绑定端口和ip</span><br><span class="line">参数：</span><br><span class="line">    sockfd：套接字</span><br><span class="line">    addr：ipv4套接字结构体地址</span><br><span class="line">    addrlen：ipv4套接字结构体的大小</span><br><span class="line">返回值：</span><br><span class="line">    成功<span class="number">0</span></span><br><span class="line">    失败<span class="number">-1</span></span><br></pre></td></tr></table></figure>

<h4 id="3-6-listen"><a href="#3-6-listen" class="headerlink" title="3.6 listen"></a>3.6 listen</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">listen</span><span class="params">(<span class="type">int</span> s, <span class="type">int</span> backlog)</span>;</span><br><span class="line">功能：</span><br><span class="line">    在一个套接字上设置倾听连接</span><br><span class="line">参数：</span><br><span class="line">    s：套接字</span><br><span class="line">    backlog：已完成连接队列和未完成连接队列数值和的最大值 <span class="number">128</span></span><br><span class="line">返回值：</span><br><span class="line">    成功：<span class="number">0</span></span><br><span class="line">    失败：<span class="number">-1</span>，并设置相应错误代码</span><br></pre></td></tr></table></figure>

<h4 id="3-7-accept"><a href="#3-7-accept" class="headerlink" title="3.7 accept"></a>3.7 accept</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">accept</span><span class="params">(<span class="type">int</span> socket, <span class="keyword">struct</span> sockaddr* address, <span class="type">socklen_t</span>* addrlen)</span>;</span><br><span class="line">功能：</span><br><span class="line">    在一个套接字上接收一个连接,如果连接队列没有新的连接，accept回阻塞</span><br><span class="line">参数：</span><br><span class="line">    socket：套接字</span><br><span class="line">    address：获取客户端的ip和端口信息 ipv4套接字结构体地址</span><br><span class="line">    addrlen：IPv4套接字结构体的大小的地址</span><br><span class="line">返回值：</span><br><span class="line">    成功：新的已连接套接字的文件描述符</span><br><span class="line">    失败：<span class="number">-1</span></span><br></pre></td></tr></table></figure>

<p>这里要说明一下，accept很任意被系统的中断给关闭，所以在使用accept的时候我们需要添加一个判断，并且要过滤系统中断</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">agare:</span><br><span class="line">ret = accept(sock, &amp;ipv4, &amp;ipv4_len);</span><br><span class="line"><span class="keyword">if</span> (ret == <span class="number">-1</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span> ((errno == ECONNABORTED) || (errno == EINTR))&#123;</span><br><span class="line">        <span class="keyword">goto</span> agare;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        perror(<span class="string">&quot;accept&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-8-tcp服务器通信步骤"><a href="#3-8-tcp服务器通信步骤" class="headerlink" title="3.8 tcp服务器通信步骤"></a>3.8 tcp服务器通信步骤</h4><p>1.创建套接字 socket</p>
<p>2.绑定 bind</p>
<p>3.监听 listen</p>
<p>4.提取 accept</p>
<p>5.读写</p>
<p>6.关闭</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SIZE 1024</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">int</span> sock_fd, new_sock_fd, ret = <span class="number">-1</span>, size, n;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">sa</span>;</span></span><br><span class="line">    <span class="type">char</span> buf[SIZE];</span><br><span class="line">    sa.sin_family = AF_INET;</span><br><span class="line">    sa.sin_port = htons(<span class="number">8000</span>);</span><br><span class="line">    <span class="comment">//inet_pton(AF_INET, &quot;192.168.160.132&quot;, &amp;sa.sin_addr.s_addr);</span></span><br><span class="line">    sa.sin_addr.s_addr = INADDR_ANY;<span class="comment">//绑定的是通配地址</span></span><br><span class="line">    <span class="comment">//1.创建套接字</span></span><br><span class="line">    sock_fd = socket(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (sock_fd == SO_ERROR)&#123;</span><br><span class="line">        perror(<span class="string">&quot;socket&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//2.绑定bind</span></span><br><span class="line">    ret = bind(sock_fd, (<span class="keyword">struct</span> sockaddr*)&amp;sa, <span class="keyword">sizeof</span>(sa));</span><br><span class="line">    <span class="keyword">if</span> (ret == SO_ERROR)&#123;</span><br><span class="line">        perror(<span class="string">&quot;bind&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//3.监听listen</span></span><br><span class="line">    ret = listen(sock_fd, <span class="number">128</span>);</span><br><span class="line">    <span class="keyword">if</span> (ret == SO_ERROR)&#123;</span><br><span class="line">        perror(<span class="string">&quot;listen&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    size = <span class="keyword">sizeof</span>(sa);</span><br><span class="line">    <span class="comment">//4.提取accept</span></span><br><span class="line">    new_sock_fd = accept(sock_fd, (<span class="keyword">struct</span> sockaddr*)&amp;sa, &amp;size);</span><br><span class="line">    <span class="keyword">if</span> (new_sock_fd == <span class="number">-1</span>)&#123;</span><br><span class="line">        perror(<span class="string">&quot;accept&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;hello, word\n&quot;</span>);</span><br><span class="line">    <span class="comment">//5.读写</span></span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">        n = read(STDIN_FILENO, buf, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">        write(new_sock_fd, buf, SIZE);</span><br><span class="line">        <span class="built_in">memset</span>(buf, <span class="number">0</span>, SIZE);</span><br><span class="line">        n = read(new_sock_fd, buf, SIZE);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;He speak:%s\n&quot;</span>, buf);</span><br><span class="line">        <span class="built_in">memset</span>(buf, <span class="number">0</span>, SIZE);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//7.关闭</span></span><br><span class="line">    close(new_sock_fd);</span><br><span class="line">    close(sock_fd);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里可以利用read读取客户端发送的数据长度来判断客户端是否关闭，当read读取的内容为0，就可以判断客户端关闭。</p>
<h4 id="3-9-tcp服务器多客户端连接（进程版）"><a href="#3-9-tcp服务器多客户端连接（进程版）" class="headerlink" title="3.9 tcp服务器多客户端连接（进程版）"></a>3.9 tcp服务器多客户端连接（进程版）</h4><p>3.8中的只能连接一个客户端，但如果我们这个服务端要连接多个客户端，这个时候就需要使用到之前学过的进程方面的知识点了，过程如下：</p>
<p>主进程连接队列，子进程处理进入已连接队列的套接字</p>
<p><img src="https://gitee.com/Mr_zhang_yu_ge/puillimage/raw/master/%E5%A4%9A%E8%BF%9B%E7%A8%8B%E6%9C%8D%E5%8A%A1%E7%AB%AF.png"></p>
<p>按照这样设计，那么主进程中就可以不需要已连接队列的操作，子进程就可以不需要未连接队列。</p>
<p>代码设计如下：</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">1.创建套接字</span><br><span class="line">2.绑定端口</span><br><span class="line">3.监听</span><br><span class="line">4.提取连接</span><br><span class="line">5.创建进程</span><br><span class="line">6.关闭</span><br></pre></td></tr></table></figure>

<p>代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">fun1</span><span class="params">(<span class="type">int</span> signum, <span class="type">siginfo_t</span>* info, <span class="type">void</span>* context)</span>&#123;</span><br><span class="line">    <span class="type">int</span> p;</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">        p = waitpid(<span class="number">-1</span>, <span class="literal">NULL</span>, WNOHANG);</span><br><span class="line">        <span class="keyword">if</span> (p &lt;= <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="comment">//没有子进程要退出</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;信号为:%d\n子进程退出\n&quot;</span>, signum);</span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">int</span> sock = <span class="number">-1</span>, ret = <span class="number">-1</span>, forkNumber = <span class="number">-1</span>, new_sock = <span class="number">-1</span>, ipv4_len;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">ipv4</span>, <span class="title">client_ipv4</span>;</span></span><br><span class="line">    <span class="comment">//设置一个阻塞集，避免在接收信号之前就有这个信号</span></span><br><span class="line">    <span class="type">sigset_t</span> <span class="built_in">set</span>;</span><br><span class="line">    sigemptyset(&amp;<span class="built_in">set</span>);</span><br><span class="line">    sigaddset(&amp;<span class="built_in">set</span>, SIGCHLD);</span><br><span class="line">    sigprocmask(SIG_BLOCK, &amp;<span class="built_in">set</span>, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="comment">//1.创建套接字</span></span><br><span class="line">    sock = socket(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (sock == <span class="number">-1</span>)&#123;</span><br><span class="line">        perror(<span class="string">&quot;socket&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//2.绑定端口</span></span><br><span class="line">    ipv4.sin_family = AF_INET;</span><br><span class="line">    ipv4.sin_port = htons(<span class="number">8000</span>);</span><br><span class="line">    inet_pton(AF_INET, <span class="string">&quot;192.168.40.131&quot;</span>, &amp;ipv4.sin_addr.s_addr);</span><br><span class="line">    ret = bind(sock, (<span class="keyword">struct</span> sockaddr*)&amp;ipv4, <span class="keyword">sizeof</span>(ipv4));</span><br><span class="line">    <span class="keyword">if</span> (ret == <span class="number">-1</span>)&#123;</span><br><span class="line">        perror(<span class="string">&quot;bind&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//3.监听</span></span><br><span class="line">    ret = listen(sock, <span class="number">128</span>);</span><br><span class="line">    <span class="keyword">if</span> (ret == <span class="number">-1</span>)&#123;</span><br><span class="line">        perror(<span class="string">&quot;listen&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//5.提取连接</span></span><br><span class="line">        <span class="type">char</span> ip[<span class="number">16</span>];</span><br><span class="line">        ipv4_len = <span class="keyword">sizeof</span>(ipv4);</span><br><span class="line">        again:</span><br><span class="line">        new_sock = accept(sock, (<span class="keyword">struct</span> sockaddr*)&amp;ipv4, &amp;ipv4_len);</span><br><span class="line">        <span class="keyword">if</span> (new_sock &lt; <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">if</span> ((errno == ECONNABORTED) || (errno == EINTR))&#123;</span><br><span class="line">                <span class="keyword">goto</span> again;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                perror(<span class="string">&quot;accept&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;new client ip:%s port:%d\n&quot;</span>, inet_ntop(AF_INET, &amp;ipv4.sin_addr.s_addr, ip, <span class="number">16</span>), ntohs(ipv4.sin_port));</span><br><span class="line">        <span class="keyword">if</span> (new_sock == <span class="number">-1</span>)&#123;</span><br><span class="line">            perror(<span class="string">&quot;accept&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//4.创建进程</span></span><br><span class="line">        forkNumber = fork();</span><br><span class="line">        <span class="keyword">if</span> (forkNumber == <span class="number">-1</span>)&#123;</span><br><span class="line">            perror(<span class="string">&quot;fork&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (forkNumber == <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="comment">//关闭等待队列</span></span><br><span class="line">            <span class="type">char</span> buf[<span class="number">1024</span>] = <span class="string">&quot;&quot;</span>;</span><br><span class="line">            ret = close(sock);</span><br><span class="line">            <span class="type">int</span> n;</span><br><span class="line">            <span class="comment">//对就绪的套接字进行操作</span></span><br><span class="line">            <span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">                n = read(new_sock, buf, <span class="number">1024</span>);</span><br><span class="line">                <span class="keyword">if</span> (n == <span class="number">0</span>)&#123;</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;new client ip:%s port:%d is close!\n&quot;</span>, inet_ntop(AF_INET, &amp;ipv4.sin_addr.s_addr, ip, <span class="number">16</span>), ntohs(ipv4.sin_port));</span><br><span class="line">                    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (n == <span class="number">-1</span>)&#123;</span><br><span class="line">                    <span class="comment">//客户端退出</span></span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;new client ip:%s port:%d is close!\n&quot;</span>, inet_ntop(AF_INET, &amp;ipv4.sin_addr.s_addr, ip, <span class="number">16</span>), ntohs(ipv4.sin_port));</span><br><span class="line">                    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span>&#123;</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, buf);</span><br><span class="line">                    write(new_sock, buf, n);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="comment">//父进程</span></span><br><span class="line">            <span class="comment">//关闭就绪队列</span></span><br><span class="line">            ret = close(new_sock);</span><br><span class="line">            <span class="keyword">while</span>(ret == <span class="number">-1</span>)&#123;</span><br><span class="line">                perror(<span class="string">&quot;close&quot;</span>);</span><br><span class="line">                ret = close(new_sock);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//当子进程结束后，会产生一个信号</span></span><br><span class="line">            <span class="comment">//6.关闭</span></span><br><span class="line">            <span class="class"><span class="keyword">struct</span> <span class="title">sigaction</span> <span class="title">act</span>;</span></span><br><span class="line">            act.sa_sigaction = fun1;</span><br><span class="line">            act.sa_flags = <span class="number">0</span>;</span><br><span class="line">            sigemptyset(&amp;act.sa_mask);</span><br><span class="line">            sigaction(SIGCHLD, &amp;act, <span class="literal">NULL</span>);</span><br><span class="line">            sigprocmask(SIG_UNBLOCK, &amp;<span class="built_in">set</span>, <span class="literal">NULL</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-10-tcp服务器多客户端连接（线程版）"><a href="#3-10-tcp服务器多客户端连接（线程版）" class="headerlink" title="3.10 tcp服务器多客户端连接（线程版）"></a>3.10 tcp服务器多客户端连接（线程版）</h4><p>其实设计的逻辑和进程的差不多</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PORT 9999</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IP <span class="string">&quot;192.168.18.128&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SIZE 512</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">SockMessage</span>&#123;</span></span><br><span class="line">    <span class="type">int</span> sockfd;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">clientaddr</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span>* <span class="title function_">recvThread</span><span class="params">(<span class="type">void</span>* sockfd)</span>&#123;</span><br><span class="line">    <span class="type">char</span> buf[SIZE];</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">SockMessage</span> <span class="title">message</span> =</span> *((<span class="keyword">struct</span> SockMessage*)sockfd);</span><br><span class="line">    <span class="type">int</span> n;</span><br><span class="line">    <span class="comment">// 用来接收客户端传过来的信息</span></span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">        n = recv(message.sockfd, buf, SIZE, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (n &lt; <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;fail not recv\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (n == <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;The client quited\n&quot;</span>);</span><br><span class="line">            pthread_exit(<span class="literal">NULL</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strcmp</span>(buf, <span class="string">&quot;exit&quot;</span>) == <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[%s %d] is exit\n&quot;</span>, inet_ntoa(message.clientaddr.sin_addr), ntohs(message.clientaddr.sin_port));</span><br><span class="line">            pthread_exit(<span class="literal">NULL</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        fflush(<span class="built_in">stdout</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[%s %d]:%s\n&quot;</span>, inet_ntoa(message.clientaddr.sin_addr), ntohs(message.clientaddr.sin_port), buf);</span><br><span class="line">        <span class="built_in">memset</span>(buf, <span class="number">0</span>, SIZE);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">int</span> sockfd = <span class="number">-1</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">serveraddr</span> =</span> &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">clientaddr</span> =</span> &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="type">int</span> len = <span class="keyword">sizeof</span>(<span class="keyword">struct</span> sockaddr);</span><br><span class="line">    <span class="type">int</span> new_sockfd = <span class="number">-1</span>;</span><br><span class="line">    <span class="type">int</span> on = <span class="number">1</span>;</span><br><span class="line">    sockfd = socket(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (sockfd == <span class="number">-1</span>)&#123;</span><br><span class="line">        perror(<span class="string">&quot;fail not socket&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    setsockopt(sockfd, SOL_SOCKET, SO_REUSEADDR, &amp;on, <span class="keyword">sizeof</span>(on));</span><br><span class="line">    serveraddr.sin_family = AF_INET;</span><br><span class="line">    serveraddr.sin_port = htons(PORT);</span><br><span class="line">    serveraddr.sin_addr.s_addr = inet_addr(IP);</span><br><span class="line">    <span class="keyword">if</span> (bind(sockfd, (<span class="keyword">struct</span> sockaddr*)&amp;serveraddr, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> sockaddr)) == <span class="number">-1</span>)&#123;</span><br><span class="line">        perror(<span class="string">&quot;fail not bind&quot;</span>);</span><br><span class="line">        close(sockfd);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (listen(sockfd, <span class="number">8</span>) == <span class="number">-1</span>)&#123;</span><br><span class="line">        perror(<span class="string">&quot;fail not listen&quot;</span>);</span><br><span class="line">        close(sockfd);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-3</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">        <span class="type">pthread_t</span> pid = <span class="number">-1</span>;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">SockMessage</span> <span class="title">message</span>;</span></span><br><span class="line">        <span class="comment">// 接收连接</span></span><br><span class="line">        new_sockfd = accept(sockfd, (<span class="keyword">struct</span> sockaddr*)&amp;clientaddr, &amp;len);</span><br><span class="line">        <span class="keyword">if</span> (new_sockfd &lt; <span class="number">0</span>)&#123;</span><br><span class="line">            perror(<span class="string">&quot;fail not accept&quot;</span>);</span><br><span class="line">            close(sockfd);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-3</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Get new link:[%s %d]\n&quot;</span>, inet_ntoa(clientaddr.sin_addr), ntohs(clientaddr.sin_port));</span><br><span class="line">        message.sockfd = new_sockfd;</span><br><span class="line">        message.clientaddr = clientaddr;</span><br><span class="line">        <span class="comment">// 创建线程</span></span><br><span class="line">        <span class="keyword">if</span> (pthread_create(&amp;pid, <span class="literal">NULL</span>, recvThread, (<span class="type">void</span>*)&amp;message) != <span class="number">0</span>)&#123;</span><br><span class="line">            perror(<span class="string">&quot;fail to pthread_create&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        pthread_detach(pid);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-半关闭"><a href="#4-半关闭" class="headerlink" title="4.半关闭"></a>4.半关闭</h3><p>在讲四次握手的时候说了，当调用了close后，并没有完全关闭，而会处于一种半关闭的情况，也就是主动方发生在<code>FIN_WAIT_2</code>状态时，主动方不可以在应用层发送数据，但是应用层还可以接收数据。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">shutdown</span><span class="params">(<span class="type">int</span> sockfd, <span class="type">int</span> how)</span>;</span><br><span class="line">sockfd:需要关闭的socket的描述符</span><br><span class="line">how:允许为shutdown操作选择一下几种方法：</span><br><span class="line">    SHUT_RD(<span class="number">0</span>):关闭sockfd上的读功能，此选项将不允许sockfd进行读操作。该套接字**不再接收数据**，任何当前在套接字接收缓冲区的数据将被无声丢弃掉</span><br><span class="line">    SHUT_WR(<span class="number">1</span>):关闭sockfd的写功能，此选项将不允许sockfd进行写操作，进程不能在对此套接字发出写操作</span><br><span class="line">    SHUT_RDWR(<span class="number">2</span>):关闭sockfd的读写功能。相当于调用shutdown两次：首先是以SHUT_RD，然后是SHUT_WR。</span><br></pre></td></tr></table></figure>

<h3 id="5-心跳包"><a href="#5-心跳包" class="headerlink" title="5.心跳包"></a>5.心跳包</h3><p>如果对方异常断开，本机检测不到，一直等待会浪费资源</p>
<p>所以这里可以设置一个心跳包来检测对方是不是断开了，这里的原理其实就是每隔一定的时间间隔就发送一个探测分节，如果连续发送多个探测分节对方未回，就将次连接断开</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> keepAlive = <span class="number">1</span>;</span><br><span class="line">setsockopt(listenfd, SOL_SOCKET, SO_KEEPALIVE, (<span class="type">void</span>*)&amp;keepAlive, <span class="keyword">sizeof</span>(keepAlive));</span><br></pre></td></tr></table></figure>

<h3 id="6-设置端口复用"><a href="#6-设置端口复用" class="headerlink" title="6.设置端口复用"></a>6.设置端口复用</h3><p>在有些时候操作服务端时，服务端强制退出了，这个时候还没有反应过来就会导致这个端口还在占用，需要再过一段时间才会释放调这个端口的资源，那如果我们还想继续使用这个端口就得等这个端口的释放，但是我们可以设置端口的复用来解决这个问题</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> opt = <span class="number">1</span>;</span><br><span class="line">setsockopt(listenfd, SOL_SOCKET, SO_REUSEADDR, &amp;opt, <span class="keyword">sizeof</span>(opt));</span><br></pre></td></tr></table></figure>

<p>注意：程序中设置某个端口重新使用，在这之前的其它网络程序将不能使用这个端口</p>
<h2 id="三、高并发服务器"><a href="#三、高并发服务器" class="headerlink" title="三、高并发服务器"></a>三、高并发服务器</h2><p>之前学会写了一个服务器，但之前写的服务器只是阻塞等待的服务器，也就是说来了一个客户端，服务器就需要创建一个进程或者线程去连接那个服务器，这样是很消耗资源的。</p>
<p>而还有一种服务器是非阻塞忙轮服务器，这个服务器是创建出一些进程，然后CPU就会去遍历这些进程，看看这些进程有没有空闲的，如果有客户端需要连接，CPU就会让没有连接的线程去连接，这种方法比较消耗CPU。</p>
<p>最后一种就是我们要讲的了，就是多路IO，多路IO这种方法是利用这内核的中断，当一个线程空闲后，内核就会产生一个信号给CPU，让CPU知道有进程空闲。</p>
<p>多路IO有三种监听的方式：<code>poll</code>、<code>epoll</code>、<code>select</code></p>
<p>它是用内核监听多个文件描述符的属性（读写缓冲区）变化，如果某个文件描述符的读缓冲区变化了，这个时候就是可以读了，将这个事件告知应用层。</p>
<h3 id="1-select"><a href="#1-select" class="headerlink" title="1.select"></a>1.select</h3><p>在Windows中比较采用，而且能跨平台</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">select</span><span class="params">(<span class="type">int</span> nfds, fd_set* readfds, fd_set* writefds, fd_set* exceptfds, <span class="keyword">struct</span> timeval* timeout)</span>;</span><br><span class="line">功能：监听多个文件描述符的属性变化（读写异常）</span><br><span class="line"><span class="type">void</span> <span class="title function_">FD_CLR</span><span class="params">(<span class="type">int</span> fd, fd_set* <span class="built_in">set</span>)</span>;  <span class="comment">// 将fd文件描述符从set集合中删除</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">FD_ISSET</span><span class="params">(<span class="type">int</span> fd, fd_set* <span class="built_in">set</span>)</span>; <span class="comment">// 判断fd文件描述符是否在set集合中</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">FD_SET</span><span class="params">(<span class="type">int</span> fd, fd_set* <span class="built_in">set</span>)</span>; <span class="comment">// 将fd描述符添加到set集合中</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">FD_ZERO</span><span class="params">(fd_set* <span class="built_in">set</span>)</span>;  <span class="comment">// 将set集合中的文件描述符清空</span></span><br><span class="line">参数：</span><br><span class="line">    nfds：最大文件描述符+<span class="number">1</span></span><br><span class="line">    readfds：需要监听的读的文件描述符存放集合</span><br><span class="line">    writefds：需要监听的写的文件描述符存放集合 <span class="literal">NULL</span></span><br><span class="line">    exceptfds：需要监听的异常的文件描述符存放集合 <span class="literal">NULL</span></span><br><span class="line">    timeout：多长时间监听一次 固定的时间，限时等待 <span class="literal">NULL</span> 永久监听</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">timeval</span>&#123;</span></span><br><span class="line">        <span class="type">long</span> tv_sec:<span class="comment">//秒</span></span><br><span class="line">        <span class="type">long</span> tv_usec;<span class="comment">//微秒</span></span><br><span class="line">    &#125;</span><br><span class="line">返回值：</span><br><span class="line">    返回的是变化的文件描述符的个数</span><br><span class="line">注意：变化的文件描述符会存放在监听的集合中，未变化的文件描述符会从集合中删除</span><br></pre></td></tr></table></figure>

<h4 id="1-1-使用select写TCP服务器"><a href="#1-1-使用select写TCP服务器" class="headerlink" title="1.1 使用select写TCP服务器"></a>1.1 使用select写TCP服务器</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PORT 8888     <span class="comment">// 绑定的端口</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">server</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">client</span>;</span>    <span class="comment">// 链接的客户端</span></span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line">    <span class="type">int</span> maxfd;</span><br><span class="line">    fd_set oldset, reset;</span><br><span class="line">    <span class="type">int</span> lenfd;     <span class="comment">// 存放变化的个数</span></span><br><span class="line">    <span class="type">int</span> cfd;</span><br><span class="line">    <span class="type">int</span> clientlen;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建套接字</span></span><br><span class="line">    <span class="type">int</span> lfd = socket(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (lfd &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        perror(<span class="string">&quot;socket&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    server.sin_family = AF_INET;</span><br><span class="line">    server.sin_port = htons(PORT);</span><br><span class="line">    inet_pton(AF_INET, <span class="string">&quot;127.0.0.1&quot;</span>, &amp;server.sin_addr.s_addr);</span><br><span class="line">    <span class="comment">// 绑定套接字</span></span><br><span class="line">    ret = bind(lfd, (<span class="keyword">struct</span> sockaddr*)&amp;server, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> sockaddr));</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        perror(<span class="string">&quot;bind&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 监听</span></span><br><span class="line">    ret = listen(lfd, <span class="number">128</span>);</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        perror(<span class="string">&quot;listen&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-3</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    maxfd = lfd;</span><br><span class="line">    <span class="comment">// 将集合中的内容清空</span></span><br><span class="line">    FD_ZERO(&amp;oldset);</span><br><span class="line">    FD_ZERO(&amp;reset);</span><br><span class="line">    <span class="comment">// 将lfd放进oldset中</span></span><br><span class="line">    FD_SET(lfd, &amp;oldset);</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">        reset = oldset;</span><br><span class="line">        lenfd = select(maxfd + <span class="number">1</span>, &amp;reset, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">        <span class="keyword">if</span> (lenfd &lt; <span class="number">0</span>)&#123;</span><br><span class="line">            perror(<span class="string">&quot;select&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (lenfd == <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;bbb&quot;</span>);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (FD_ISSET(lfd, &amp;reset))&#123;</span><br><span class="line">                <span class="comment">// lfd变化了，接受cfd</span></span><br><span class="line">                clientlen = <span class="keyword">sizeof</span>(client);</span><br><span class="line">                cfd = accept(lfd, (<span class="keyword">struct</span> sockaddr*)&amp;client, &amp;clientlen);</span><br><span class="line">                <span class="keyword">if</span> (cfd &lt; <span class="number">0</span>)&#123;</span><br><span class="line">                    <span class="comment">// 接收失败</span></span><br><span class="line">                    perror(<span class="string">&quot;accept&quot;</span>);</span><br><span class="line">                    <span class="keyword">continue</span>;    <span class="comment">// 跳过这次接收</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;link!client IP:%s port:%d\n&quot;</span>, inet_ntoa(client.sin_addr), ntohs(client.sin_port));</span><br><span class="line">                <span class="comment">// 接收成功将这个文件描述符添加到oldset中</span></span><br><span class="line">                FD_SET(cfd, &amp;oldset);</span><br><span class="line">                <span class="comment">// 判断一下这个描述符是否大于最大文件描述符</span></span><br><span class="line">                <span class="keyword">if</span> (cfd &gt; maxfd)&#123;</span><br><span class="line">                    maxfd = cfd;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 如果只有lfd变化那就跳过这次</span></span><br><span class="line">                <span class="keyword">if</span> (--lenfd == <span class="number">0</span>)</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> i = lfd + <span class="number">1</span>; i &lt;= maxfd; i++)&#123;</span><br><span class="line">                <span class="comment">// 判断哪个文件描述符在变化集合中</span></span><br><span class="line">                <span class="keyword">if</span> (FD_ISSET(i, &amp;reset))&#123;</span><br><span class="line">                    <span class="type">char</span> buf[<span class="number">1500</span>];</span><br><span class="line">                    ret = read(i, buf, <span class="number">1500</span>);</span><br><span class="line">                    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)&#123;</span><br><span class="line">                        <span class="comment">// 这个文件描述符有问题</span></span><br><span class="line">                        perror(<span class="string">&quot;read&quot;</span>);</span><br><span class="line">                        <span class="comment">// 关闭这个文件描述符</span></span><br><span class="line">                        close(i);</span><br><span class="line">                        <span class="comment">// 然后把这个文件描述符从中删除</span></span><br><span class="line">                        FD_CLR(i, &amp;oldset);</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> (ret == <span class="number">0</span>)&#123;</span><br><span class="line">                        <span class="comment">// 这个文件描述符已经关闭</span></span><br><span class="line">                        close(i);</span><br><span class="line">                        FD_CLR(i, &amp;oldset);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span>&#123;</span><br><span class="line">                        <span class="comment">// 正常输出</span></span><br><span class="line">                        <span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, buf);</span><br><span class="line">                        write(i, buf, <span class="built_in">strlen</span>(buf));</span><br><span class="line">                        bzero(buf, <span class="number">0</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="1-2-select的优缺点"><a href="#1-2-select的优缺点" class="headerlink" title="1.2 select的优缺点"></a>1.2 select的优缺点</h4><p>优点：跨平台</p>
<p>缺点：</p>
<p>文件描述符1024的限制，由于<code>FD_SETSIZE</code>的限制，只能返回变化的文件描述符的个数，具体哪个变化需要遍历，每次都需要将需要监听的文件描述符集合由应用层拷贝到内核。</p>
<p>大量并发，少活跃，select效率低。</p>
<p>假设现在有4-1023个文件描述符需要监听，但是5-1000这些文件描述符关闭了。</p>
<h4 id="1-3-解决缺点中的问题"><a href="#1-3-解决缺点中的问题" class="headerlink" title="1.3 解决缺点中的问题"></a>1.3 解决缺点中的问题</h4><p>这里使用到数组来进行解决。</p>
<h3 id="2-poll"><a href="#2-poll" class="headerlink" title="2.poll"></a>2.poll</h3><p>用得比较少</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">poll</span><span class="params">(<span class="keyword">struct</span> pollfd *fds, <span class="type">nfds_t</span> nfds, <span class="type">int</span> timeout)</span>;</span><br><span class="line">功能：监听多个文件描述符的首元素地址的属性变化</span><br><span class="line">参数：</span><br><span class="line">    fds:监听的数组的首元素地址</span><br><span class="line">    nfds:数组有效元素的最大下标+<span class="number">1</span></span><br><span class="line">    timeout:超时时间，<span class="number">-1</span>是永久监听，&gt;=<span class="number">0</span>限时等待</span><br><span class="line">数组元素：</span><br><span class="line">    <span class="keyword">struct</span> pollfd&#123;</span><br><span class="line">        <span class="type">int</span> fd;   <span class="comment">// 需要监听的文件描述符，如果是-1就不监听</span></span><br><span class="line">        <span class="type">short</span> events;   <span class="comment">// 需要监听的文件描述符什么事件 EPOLLIN 读事件  EPOLLOUT 写事件</span></span><br><span class="line">        <span class="type">short</span> revents;  <span class="comment">// 返回监听到的事件</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<h3 id="3-epoll"><a href="#3-epoll" class="headerlink" title="3.epoll"></a>3.epoll</h3><p>用得比较多，在Linux中使用得比较多</p>
<p>特点：</p>
<p>没有文件描述符1024的限制，以后每次监听都不需要在此将需要监听的文件描述符拷贝到内核，返回的是变化的文件描述符，不需要遍历树。</p>
<p>工作原理：</p>
<p>1.创建红黑树</p>
<p>2.将需要监听的文件描述符上树</p>
<p>3.监听</p>
<h4 id="3-1-创建红黑树"><a href="#3-1-创建红黑树" class="headerlink" title="3.1 创建红黑树"></a>3.1 创建红黑树</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/epoll.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">epoll_create</span><span class="params">(<span class="type">int</span> size)</span>;</span><br><span class="line">参数:</span><br><span class="line">    size:监听的文件描述符的上限，<span class="number">2.6</span>版本之后写<span class="number">1</span>即可</span><br><span class="line">返回值:返回树的句柄</span><br></pre></td></tr></table></figure>

<h4 id="3-2-上树、下树、修改节点"><a href="#3-2-上树、下树、修改节点" class="headerlink" title="3.2 上树、下树、修改节点"></a>3.2 上树、下树、修改节点</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/epoll.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">epoll_ctl</span><span class="params">(<span class="type">int</span> epfd, <span class="type">int</span> op, <span class="type">int</span> fd, <span class="keyword">struct</span> epoll_event* event)</span>;</span><br><span class="line">参数:</span><br><span class="line">    epfd:树的句柄</span><br><span class="line">    op:</span><br><span class="line">        EPOLL_CTL_ADD 上树</span><br><span class="line">        EPOLL_CTL_DEL 下树</span><br><span class="line">        EPOLL_CTL_MOD 修改树</span><br><span class="line">    fd:上树、下树的文件描述符</span><br><span class="line">    event:上树的结点</span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">union</span> <span class="title">epoll_data</span>&#123;</span></span><br><span class="line">    <span class="type">void</span>* ptr;</span><br><span class="line">    <span class="type">int</span> fd;</span><br><span class="line">    <span class="type">uint32_t</span> u32;</span><br><span class="line">    <span class="type">uint64_t</span> u64;</span><br><span class="line">&#125;<span class="type">epoll_data_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">epoll_event</span>&#123;</span></span><br><span class="line">    <span class="type">uint32_t</span> events;   <span class="comment">// 需要监听的事件</span></span><br><span class="line">    <span class="type">epoll_data_t</span> data;  <span class="comment">// 需要监听的文件描述符</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="3-3-监听"><a href="#3-3-监听" class="headerlink" title="3.3 监听"></a>3.3 监听</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/epoll.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">epoll_wait</span><span class="params">(<span class="type">int</span> epfd, <span class="keyword">struct</span> epoll_event* events, <span class="type">int</span> maxevents, <span class="type">int</span> timeout)</span>;</span><br><span class="line">参数:</span><br><span class="line">    epfd:树的句柄</span><br><span class="line">    events:接收变化的节点的数组的首地址</span><br><span class="line">    maxevents:数组元素的个数</span><br><span class="line">    timeout:<span class="number">-1</span>永久监听 大于<span class="number">0</span>限时等待</span><br></pre></td></tr></table></figure>



<h2 id="四、TFTP"><a href="#四、TFTP" class="headerlink" title="四、TFTP"></a>四、TFTP</h2><h3 id="1-TFTP概述"><a href="#1-TFTP概述" class="headerlink" title="1.TFTP概述"></a>1.TFTP概述</h3><p>TFTP是简单文件传送协议</p>
<p>最初用于引导无盘系统，被设计用来传输小文件</p>
<p>基于UDP协议实现，不进行用户有效性认证</p>
<p><strong>数据传输模式：</strong></p>
<p>octet：二进制模式</p>
<p>netascii：文本模式</p>
<p>mail：已经不再支持</p>
<h3 id="2-TFTP通讯过程"><a href="#2-TFTP通讯过程" class="headerlink" title="2.TFTP通讯过程"></a>2.TFTP通讯过程</h3><p><img src="https://gitee.com/Mr_zhang_yu_ge/puillimage/raw/master/TFTP%E9%80%9A%E8%AE%AF%E8%BF%87%E7%A8%8B.png"></p>
<p>1.服务器在69端口等待请求</p>
<p>2.服务器若批准此请求，则使用临时端口与客户端进行通信</p>
<p>3.每个数据包的编号都有变化（从1开始）</p>
<p>4.每个数据包都要得到ACK确认，如果出现超时，则需要重新发送最后的包（数据或ACK）</p>
<p>5.数据的长度以512Byte传输</p>
<p>6.小于512Byte的数据意味着传输结束</p>
<h3 id="3-TFTP协议分析"><a href="#3-TFTP协议分析" class="headerlink" title="3.TFTP协议分析"></a>3.TFTP协议分析</h3><p><img src="https://gitee.com/Mr_zhang_yu_ge/puillimage/raw/master/TFTP%E5%8D%8F%E8%AE%AE%E5%88%86%E6%9E%90.png"></p>
<p><strong>注意：</strong></p>
<p>以上0代表的是<code>\0</code></p>
<p>不同的差错码对应不同的错误信息</p>
<p><img src="https://gitee.com/Mr_zhang_yu_ge/puillimage/raw/master/TFTP%E5%B7%AE%E9%94%99%E7%A0%81.png"></p>
<p><strong>错误码：</strong></p>
<p>0 未定义，参见错误信息</p>
<p>1 File not found</p>
<p>2 Access violation</p>
<p>3 Disk full or allocation exceeded</p>
<p>4.illegal TFTP operation</p>
<p>5.Unknown transfer ID</p>
<p>6.File already exists</p>
<p>7.No such user</p>
<p>8.Unsuppored option(s) requested</p>
<h3 id="4-TFTP客户端"><a href="#4-TFTP客户端" class="headerlink" title="4.TFTP客户端"></a>4.TFTP客户端</h3><p>使用TFTP协议下载server上的文件到本地</p>
<p><strong>思路</strong></p>
<p>1、构造请求报文，送至服务器（69号端口）</p>
<p>2、等待服务器回应</p>
<p>3、分析服务器回应</p>
<p>4、接收数据，直到接收到的数据包小于规定长度</p>
<p>代码：</p>
<h2 id="五、UDP广播"><a href="#五、UDP广播" class="headerlink" title="五、UDP广播"></a>五、UDP广播</h2><h3 id="1-广播的概念"><a href="#1-广播的概念" class="headerlink" title="1.广播的概念"></a>1.广播的概念</h3><p>广播：由一台主机向该主机所在子网内的所有主机发送数据的方式，例如192.168.3.103发送广播信息，则192.168.3.1~192.168.3.254所有主机都可以接收到数据。</p>
<p>广播只能用UDP或者原始IP实现，不能用TCP。</p>
<h3 id="2-广播的用途"><a href="#2-广播的用途" class="headerlink" title="2.广播的用途"></a>2.广播的用途</h3><p>单个服务器与多个客户主机通讯时减少分组流通，以下几个协议都用到广播：</p>
<p>1、地址解析协议（ARP）</p>
<p>2、动态主机配置协议（DHCP）</p>
<p>3、网络时间协议（NTP）</p>
<h3 id="3-广播的特点"><a href="#3-广播的特点" class="headerlink" title="3.广播的特点"></a>3.广播的特点</h3><p>1、处于同一子网的所有主机都必须处理数据</p>
<p>2、UDP数据包会沿协议栈向上一直到UDP层</p>
<p> 3、运行音视频等较高速率工作的应用，会带来很大的负担</p>
<p>4、局限于局域网内使用</p>
<h3 id="4-广播地址"><a href="#4-广播地址" class="headerlink" title="4.广播地址"></a>4.广播地址</h3><p>{网络ID，主机ID}</p>
<p>网络ID表示由子网掩码中1覆盖的连续位</p>
<p>主机ID表示由子网掩码中0覆盖的连续位</p>
<p>**定向广播地址：**主机ID全为1</p>
<p>1、例如：对192.168.200.0&#x2F;24，其定向广播地址为：192.168.200.255</p>
<p>2、通常路由器不转发该广播</p>
<p>**受限广播地址：**255.255.255.255</p>
<p>路由器从不转发该广播</p>
<h1 id="未完待续…一直鸽着的"><a href="#未完待续…一直鸽着的" class="headerlink" title="未完待续…一直鸽着的"></a>未完待续…一直鸽着的</h1>
    </div>

    
    
    

    <footer class="post-footer">
          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>本文作者： </strong>puill
  </li>
  <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="http://www.puill.xin/2025/01/17/5f463418ae32/" title="Linux网络编程">http://www.puill.xin/2025/01/17/5f463418ae32/</a>
  </li>
  <li class="post-copyright-license">
      <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

          <div class="post-tags">
              <a href="/tags/Linux/" rel="tag"># Linux</a>
              <a href="/tags/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/" rel="tag"># 网络编程</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2025/01/17/802f7a7d62e1/" rel="prev" title="00在linux环境下搭建stm32开发环境">
                  <i class="fa fa-angle-left"></i> 00在linux环境下搭建stm32开发环境
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2025/01/17/c9e1bc87adc3/" rel="next" title="香橙派开发系列-3b系统安装和使用vscode进行远程连接">
                  香橙派开发系列-3b系统安装和使用vscode进行远程连接 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">puill</span>
  </div>

<!--
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>
--><div>
<!--添加网站运行时间-->
<span>小破站已经在风雨中度过了</span>
<span id="timeDate">载入天数...</span>
<span id="times">载入时分秒...</span>
<script>
    function createtime() {
        const startTime = '01/10/2025 00:00:00',
            start = new Date(startTime)
        let mill = new Date() - start,
            seconds = Math.floor(mill / 1000),
            mins = Math.floor(seconds / 60),
            hours = Math.floor(mins / 60),
            days = Math.floor(hours / 24)
        const time = {
            seconds: seconds - mins * 60,
            mins: mins - hours * 60,
            hours: hours - days * 24,
        }
        for (const k in time) {
            time[k] = `${time[k]}`.padStart(2, '0')
        }
        document.getElementById("timeDate").innerHTML = ` ${days} 天`
        document.getElementById("times").innerHTML = ` ${time.hours} 小时 ${time.mins} 分 ${time.seconds} 秒`
    }
    setInterval(createtime, 500)
</script>
</div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>







  





</body>
</html>
